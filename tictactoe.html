<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tic Tac Toe | Ultimate</title>

<style>
:root {
    --bg: #0f172a;       /* Dark Blue/Slate */
    --card: #1e293b;     /* Card Background */
    --cell: #334155;     /* Cell Background */
    --accent: #38bdf8;   /* Neon Blue */
    --text: #f8fafc;     /* White Text */
    --win: #4ade80;      /* Green */
    --lose: #f87171;     /* Red */
}

* {
    box-sizing: border-box;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
}

body {
    margin: 0;
    background: var(--bg);
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    color: var(--text);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    overflow: hidden; /* Prevents scroll when confetti falls */
}

#app {
    width: min(92vw, 400px);
    background: var(--card);
    padding: 24px;
    border-radius: 24px;
    box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    animation: fadeUp 0.5s ease-out;
}

@keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

h2 {
    text-align: center;
    margin: 0 0 24px 0;
    font-weight: 800;
    letter-spacing: -0.5px;
    font-size: 1.8rem;
    background: linear-gradient(to right, #38bdf8, #818cf8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* --- Form Elements --- */
.section {
    margin-bottom: 20px;
}

.label-title {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: #94a3b8;
    margin-bottom: 10px;
    display: block;
    font-weight: 700;
}

.options {
    display: flex;
    background: rgba(0, 0, 0, 0.3);
    padding: 4px;
    border-radius: 12px;
    gap: 4px;
}

.options label {
    flex: 1;
    cursor: pointer;
    position: relative;
    z-index: 1;
}

.options input {
    display: none;
}

.options span {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 10px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.2s ease;
    color: #cbd5e1;
}

.options input:checked + span {
    background: var(--accent);
    color: #0f172a;
    box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3);
}

/* --- Buttons --- */
button {
    font-family: inherit;
    border: none;
    cursor: pointer;
    transition: transform 0.1s, opacity 0.2s;
}

button:active {
    transform: scale(0.96);
}

.primary-btn {
    width: 100%;
    padding: 16px;
    font-size: 1.1rem;
    border-radius: 14px;
    background: var(--accent);
    color: #0f172a;
    font-weight: 800;
    margin-top: 8px;
    box-shadow: 0 4px 0 #0ea5e9; /* 3D effect */
}

.primary-btn:active {
    box-shadow: 0 0 0 #0ea5e9;
    transform: translateY(4px);
}

#musicBtn {
    margin-top: 16px;
    background: transparent;
    border: 2px solid rgba(255, 255, 255, 0.1);
    color: #94a3b8;
    padding: 12px;
    border-radius: 12px;
    font-size: 0.9rem;
    font-weight: 600;
    box-shadow: none;
}

/* --- Game Board --- */
#board {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin: 20px 0;
}

.cell {
    aspect-ratio: 1;
    background: var(--cell);
    border-radius: 16px;
    font-size: clamp(40px, 15vw, 64px);
    font-weight: 900;
    color: var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 0 rgba(0,0,0,0.3);
    transition: background 0.2s, transform 0.1s;
}

.cell:not(.taken):active {
    transform: translateY(6px);
    box-shadow: none;
}

.cell.taken {
    background: #1e293b; /* Slightly darker */
    box-shadow: inset 0 4px 8px rgba(0,0,0,0.4);
    transform: none;
    cursor: default;
}

.cell.win {
    background: var(--win);
    color: #064e3b;
    animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes pop {
    0% { transform: scale(0.8); }
    100% { transform: scale(1); }
}

/* --- Utilities --- */
.hidden { display: none !important; }

#status {
    text-align: center;
    font-size: 1.2rem;
    font-weight: 700;
    min-height: 1.5em;
    color: #e2e8f0;
}

.disabled-board {
    pointer-events: none;
    opacity: 0.8;
}

/* --- Confetti --- */
.confetti {
    position: fixed;
    top: -10px;
    z-index: 9999;
    animation: fall linear forwards;
}

@keyframes fall {
    to { transform: translateY(110vh) rotate(720deg); }
}
</style>
</head>

<body>

<div id="app">

    <div id="settings">
        <h2>Tic Tac Toe</h2>

        <div class="section">
            <span class="label-title">Choose Side</span>
            <div class="options">
                <label><input type="radio" name="marker" value="X" checked><span>Play as X</span></label>
                <label><input type="radio" name="marker" value="O"><span>Play as O</span></label>
            </div>
        </div>

        <div class="section">
            <span class="label-title">Who Starts?</span>
            <div class="options">
                <label><input type="radio" name="first" value="player" checked><span>You</span></label>
                <label><input type="radio" name="first" value="computer"><span>Computer</span></label>
            </div>
        </div>

        <div class="section">
            <span class="label-title">Difficulty</span>
            <div class="options">
                <label><input type="radio" name="difficulty" value="easy"><span>Easy</span></label>
                <label><input type="radio" name="difficulty" value="medium" checked><span>Med</span></label>
                <label><input type="radio" name="difficulty" value="hard"><span>Hard</span></label>
            </div>
        </div>

        <button class="primary-btn" onclick="startGame()">Start Game</button>
        <button id="musicBtn" onclick="toggleMusic()">ðŸ”Š Sound On</button>
    </div>

    <div id="game" class="hidden">
        <div id="status">Your Turn</div>
        <div id="board"></div>
        <button class="primary-btn" style="background: #475569; box-shadow: 0 4px 0 #334155;" onclick="resetGame()">Restart Game</button>
    </div>

</div>

<script>
/* --- AUDIO SYSTEM --- */
const ASSETS = {
    // Background Music (Lo-fi Loop)
    bgm: "https://raw.githubusercontent.com/redsolver/flutter_flappy_bird/master/assets/audio/theme.mp3",
    // Sound Effects
    tap: "https://raw.githubusercontent.com/maykbrito/libs/main/sounds/button.wav",
    win: "https://raw.githubusercontent.com/redsolver/flutter_flappy_bird/master/assets/audio/point.mp3",
    lose: "https://raw.githubusercontent.com/redsolver/flutter_flappy_bird/master/assets/audio/die.mp3"
};

const audio = {
    bgm: new Audio(ASSETS.bgm),
    tap: new Audio(ASSETS.tap),
    win: new Audio(ASSETS.win),
    lose: new Audio(ASSETS.lose)
};

// Audio Config
audio.bgm.loop = true;
audio.bgm.volume = 0.4;
let soundEnabled = true;

function playSound(name) {
    if (!soundEnabled) return;
    const sound = audio[name];
    sound.currentTime = 0; // Rewind to start for rapid clicks
    sound.play().catch(e => console.log("Browser blocked audio:", e));
}

function toggleMusic() {
    soundEnabled = !soundEnabled;
    const btn = document.getElementById("musicBtn");
    btn.innerText = soundEnabled ? "ðŸ”Š Sound On" : "ðŸ”‡ Sound Off";
    
    if (soundEnabled) {
        // If we are in-game, resume BGM
        if (!document.getElementById("game").classList.contains("hidden")) {
            audio.bgm.play().catch(e => {});
        }
    } else {
        audio.bgm.pause();
    }
}

/* --- GAME LOGIC --- */
const WIN_COMBOS = [
    [0,1,2],[3,4,5],[6,7,8], // Rows
    [0,3,6],[1,4,7],[2,5,8], // Cols
    [0,4,8],[2,4,6]          // Diagonals
];

let board = [];
let player = "X";
let computer = "O";
let turn = "X";
let difficulty = "medium";
let gameOver = false;
let computerTimer = null; // Stores the timeout ID to prevent ghost moves

function startGame() {
    // 1. Get Settings
    player = document.querySelector('input[name="marker"]:checked').value;
    computer = player === "X" ? "O" : "X";
    difficulty = document.querySelector('input[name="difficulty"]:checked').value;
    const first = document.querySelector('input[name="first"]:checked').value;
    turn = first === "player" ? player : computer;

    // 2. Initialize
    board = Array(9).fill(null);
    gameOver = false;
    clearTimeout(computerTimer); // CRITICAL FIX: Kill any pending CPU moves

    // 3. UI Transition
    document.getElementById("settings").classList.add("hidden");
    document.getElementById("game").classList.remove("hidden");
    renderBoard();
    updateStatus();

    // 4. Start Music
    if (soundEnabled) audio.bgm.play().catch(e => console.log("Tap to start audio"));

    // 5. Computer First?
    if (turn === computer) {
        document.getElementById("board").classList.add("disabled-board");
        computerTimer = setTimeout(computerMove, 800);
    }
}

function renderBoard() {
    const boardEl = document.getElementById("board");
    boardEl.innerHTML = "";
    boardEl.className = (turn === computer || gameOver) ? "disabled-board" : "";

    board.forEach((cell, i) => {
        const btn = document.createElement("button");
        btn.className = `cell ${cell ? 'taken' : ''}`;
        btn.innerText = cell || "";
        btn.onclick = () => playerMove(i);
        boardEl.appendChild(btn);
    });
}

function playerMove(i) {
    if (gameOver || board[i] || turn !== player) return;
    
    // Player Turn
    playSound("tap");
    makeMove(i, player);

    if (!checkGameEnd(player)) {
        turn = computer;
        renderBoard(); // Disables board
        updateStatus();
        // CPU "Thinking" Delay
        computerTimer = setTimeout(computerMove, 600 + Math.random() * 400);
    }
}

function computerMove() {
    if (gameOver) return;

    let idx;
    
    // --- DIFFICULTY LOGIC ---
    if (difficulty === "easy") {
        // Suicide Mode: Finds the move that is WORST for the computer
        idx = getWorstMove();
    } else if (difficulty === "medium") {
        // 30% chance to be random, 70% chance to be smart
        idx = Math.random() < 0.3 ? getRandomMove() : getBestMove();
    } else {
        // Hard: 100% Perfect Minimax
        idx = getBestMove();
    }

    playSound("tap"); // Sound for AI too!
    makeMove(idx, computer);

    if (!checkGameEnd(computer)) {
        turn = player;
        renderBoard(); // Re-enables board
        updateStatus();
    }
}

function makeMove(i, who) {
    board[i] = who;
    renderBoard();
}

function checkGameEnd(lastPlayer) {
    // 1. Check Win
    const winningCombo = WIN_COMBOS.find(c => c.every(i => board[i] === lastPlayer));
    
    if (winningCombo) {
        gameOver = true;
        const isPlayerWin = lastPlayer === player;
        
        // Highlight Cells
        const cells = document.getElementsByClassName("cell");
        winningCombo.forEach(i => cells[i].classList.add("win"));
        
        endGame(isPlayerWin ? "You Win! ðŸŽ‰" : "Computer Wins ðŸ¤–", isPlayerWin);
        return true;
    }

    // 2. Check Draw
    if (board.every(cell => cell !== null)) {
        gameOver = true;
        endGame("It's a Draw ðŸ˜", false);
        return true;
    }

    return false;
}

function endGame(msg, isWin) {
    document.getElementById("status").innerText = msg;
    document.getElementById("board").classList.remove("disabled-board"); // Allow clicking Restart
    
    if (isWin) {
        playSound("win");
        launchConfetti();
    } else if (msg.includes("Draw")) {
        // No sound or generic sound
    } else {
        playSound("lose");
    }
}

function updateStatus() {
    if (gameOver) return;
    document.getElementById("status").innerText = 
        turn === player ? "Your Turn" : "Computer is thinking...";
}

function resetGame() {
    clearTimeout(computerTimer); // Stop CPU
    audio.bgm.pause();
    audio.bgm.currentTime = 0;
    document.getElementById("settings").classList.remove("hidden");
    document.getElementById("game").classList.add("hidden");
}

/* --- AI ALGORITHMS --- */

function getRandomMove() {
    const empty = board.map((v, i) => v === null ? i : null).filter(v => v !== null);
    if (empty.length === 0) return -1;
    return empty[Math.floor(Math.random() * empty.length)];
}

// "Suicide" AI for Easy Mode
function getWorstMove() {
    let worstScore = Infinity; 
    let move = -1;
    const empty = board.map((v, i) => v === null ? i : null).filter(v => v !== null);

    // If opening, play random to not be boring
    if (empty.length >= 8) return getRandomMove();

    for (let i of empty) {
        board[i] = computer;
        // Check what the result of this move is
        let score = minimax(board, 0, false);
        board[i] = null;

        // We want the score to be as LOW as possible (favoring Player Win)
        if (score < worstScore) {
            worstScore = score;
            move = i;
        }
    }
    return move !== -1 ? move : getRandomMove();
}

// Perfect AI for Hard Mode
function getBestMove() {
    let bestScore = -Infinity;
    let move = -1;
    const empty = board.map((v, i) => v === null ? i : null).filter(v => v !== null);

    // Opening optimization
    if (empty.length === 9) return 4;
    if (empty.length === 8 && board[4] === null) return 4;

    for (let i of empty) {
        board[i] = computer;
        let score = minimax(board, 0, false);
        board[i] = null;
        if (score > bestScore) {
            bestScore = score;
            move = i;
        }
    }
    return move;
}

function minimax(bd, depth, isMaximizing) {
    // Check terminal states
    if (checkWin(bd, computer)) return 10 - depth;
    if (checkWin(bd, player)) return depth - 10;
    if (bd.every(c => c !== null)) return 0;

    const empty = bd.map((v, i) => v === null ? i : null).filter(v => v !== null);

    if (isMaximizing) {
        let maxEval = -Infinity;
        for (let i of empty) {
            bd[i] = computer;
            let eval = minimax(bd, depth + 1, false);
            bd[i] = null;
            maxEval = Math.max(maxEval, eval);
        }
        return maxEval;
    } else {
        let minEval = Infinity;
        for (let i of empty) {
            bd[i] = player;
            let eval = minimax(bd, depth + 1, true);
            bd[i] = null;
            minEval = Math.min(minEval, eval);
        }
        return minEval;
    }
}

function checkWin(bd, who) {
    return WIN_COMBOS.some(c => c.every(i => bd[i] === who));
}

/* --- VISUAL EFFECTS --- */
function launchConfetti() {
    const colors = ['#38bdf8', '#4ade80', '#f472b6', '#facc15'];
    for (let i = 0; i < 150; i++) {
        const c = document.createElement("div");
        c.className = "confetti";
        c.style.left = Math.random() * 100 + "vw";
        c.style.width = Math.random() * 8 + 4 + "px";
        c.style.height = Math.random() * 8 + 4 + "px";
        c.style.background = colors[Math.floor(Math.random() * colors.length)];
        c.style.borderRadius = "50%";
        
        let duration = Math.random() * 3 + 2;
        c.style.animationDuration = duration + "s";
        
        document.body.appendChild(c);
        setTimeout(() => c.remove(), duration * 1000);
    }
}
</script>
</body>
</html>
